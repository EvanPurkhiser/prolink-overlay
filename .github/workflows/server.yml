
name: deploy server
on: [push]

jobs:
  deploy:
    name: deploy server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Build Dockerfile.server
        run: |
          docker build . -t evanpurkhiser/prolink-tools-server -f conf/Dockerfile.server

      - name: Publish
        run: |
          docker login --username=evanpurkhiser --password-stdin <<< "${{ secrets.DOCKER_HUB_TOKEN }}"
          docker push evanpurkhiser/prolink-tools-server:latest

      - name: Setup ssh-agent
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.DIGITAL_OCEAN_PRIVATE_KEY }}

      - name: Add known hosts for api.prolink.tools
        run: ssh-keyscan -H api.prolink.tools > ~/.ssh/known_hosts

      - name: Copy server-compose file
        run: |
          scp ./conf/server-compose.yml root@api.prolink.tools:./

      - name: Update images
        run: |
          ssh root@api.prolink.tools << EOF
            docker-compose -f ./server-compose.yml pull --quiet
            docker-compose -f ./server-compose.yml rm --force --stop -v prolink-tools
            docker-compose -f ./server-compose.yml up --detach
            docker system prune --all --force
          EOF
